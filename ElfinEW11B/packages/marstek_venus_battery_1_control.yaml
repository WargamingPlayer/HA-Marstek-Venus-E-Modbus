# ----------------------------------------------------------------
# Version: 2025.12.1
# Note: Only for Marstek EMS 153 or higher
# By: WargamingPlayer
# Fork of https://github.com/Superduper1969/MarstekVenus-ElfinEW11
# ----------------------------------------------------------------
# Scheduler Edition.
# Use this file for the first Marstek Venus.
# ----------------------------------------------------------------

# ------
# MODBUS
# ------
modbus:
  - name: MarstekVenus1
    type: tcp
    host: [YourIPGoesHere]
    port: 502
    delay: 1
    message_wait_milliseconds: 35
    timeout: 5

    sensors:
      # 30000
      # 30001 = 32100
      # 30002 = 32101
      # 30003
      # 30004 = 32200
      # 30005 = 32100
      # 30006 = 32300
      # 30007
      # 30008 = 35001 Only V1 & V2
      # 30009 = 35002 Only V1 & V2
      # 30010 = 35000
      # 30100 = 36100
      # 30200

      - name: "Marstek 1 WiFi Status"
        unique_id: marstek_1_wifi_status
        address: 30300
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        state_class: measurement
        # 0 = Disconnected
        # 1 = Connected

      - name: "Marstek 1 BT Status"
        unique_id: marstek_1_bt_status
        address: 30301
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        state_class: measurement
        # 0 = Disconnected
        # 1 = Connected after reboot
        # 2 = Connected
        # 3 = Active

      - name: "Marstek 1 Cloud Status"
        unique_id: marstek_1_cloud_status
        address: 30302
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        state_class: measurement
        # 0 = Disconnected
        # 1 = Connected

      - name: "Marstek 1 WiFi Signal strength"
        unique_id: marstek_1_wifi_signal_strength
        address: 30303
        slave: 1
        scan_interval: 10
        input_type: holding
        data_type: int16
        unit_of_measurement: dBm
        device_class: signal_strength
        state_class: measurement
        scale: -1
        offset: 0
        precision: 0

      # Only V3
      #- name: "Marstek 1 MAC"
      #  unique_id: marstek_1_mac
      #  address: 30304
      #  slave: 1
      #  scan_interval: 300
      #  input_type: holding
      #  data_type: custom
      #  count: 6
      #  structure: ">12s"

      # 30399 = 31102 (in hex)
      # 30400 = 31100 (in hex)
      # 30401 = 31101 (in hex)

      # Only V1 & V2
      - name: "Marstek 1 MAC"
        unique_id: marstek_1_mac
        address: 30402
        slave: 1
        scan_interval: 300
        input_type: holding
        data_type: custom
        count: 6
        structure: ">12s"

      # Only V3
      #- name: "Marstek 1 COM Module version"
      #  unique_id: marstek_1_com_module_version
      #  address: 30350
      #  slave: 1
      #  scan_interval: 300
      #  input_type: holding
      #  data_type: custom
      #  count: 6
      #  structure: ">12s"

      # 30500
      # 30600
      # 30700

      # Only V1 & V2
      - name: "Marstek 1 COM Module version"
        unique_id: marstek_1_com_module_version
        address: 30800
        slave: 1
        scan_interval: 300
        input_type: holding
        data_type: custom
        count: 6
        structure: ">12s"

      - name: "Marstek 1 Name"
        unique_id: marstek_1_name
        address: 31000
        slave: 1
        scan_interval: 300
        input_type: holding
        data_type: custom
        count: 10
        structure: ">20s"

      - name: "Marstek 1 Software version"
        unique_id: marstek_1_software_version
        address: 31100
        slave: 1
        scan_interval: 300
        input_type: holding
        data_type: uint16
        scale: 0.1
        offset: 0
        precision: 1

      - name: "Marstek 1 EMS version"
        unique_id: marstek_1_ems_version
        address: 31101
        slave: 1
        scan_interval: 300
        input_type: holding
        data_type: uint16
        scale: 1
        offset: 0
        precision: 0

      - name: "Marstek 1 BMS version"
        unique_id: marstek_1_bms_version
        address: 31102
        slave: 1
        scan_interval: 300
        input_type: holding
        data_type: uint16
        scale: 1
        offset: 0
        precision: 0

      # 31200 SN but is empty

      - name: "Marstek 1 Battery Voltage"
        unique_id: marstek_1_battery_voltage
        address: 32100
        slave: 1
        scan_interval: 10
        input_type: holding
        data_type: uint16
        unit_of_measurement: V
        device_class: voltage
        state_class: measurement
        scale: 0.01
        offset: 0
        precision: 1

      - name: "Marstek 1 Battery Current"
        unique_id: marstek_1_battery_current
        address: 32101
        slave: 1
        scan_interval: 10
        input_type: holding
        data_type: int16
        unit_of_measurement: A
        device_class: current
        state_class: measurement
        scale: 0.01
        offset: 0
        precision: 1

      - name: "Marstek 1 Battery Power"
        unique_id: marstek_1_battery_power
        address: 32102
        slave: 1
        scan_interval: 10
        input_type: holding
        data_type: int32
        unit_of_measurement: W
        device_class: power
        state_class: measurement
        scale: 1
        offset: 0
        precision: 0

      - name: "Marstek 1 Battery SOC"
        unique_id: marstek_1_battery_soc
        address: 32104
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        unit_of_measurement: "%"
        device_class: battery
        state_class: measurement
        scale: 1
        offset: 0
        precision: 0

      - name: "Marstek 1 Battery Energy"
        unique_id: marstek_1_battery_energy
        address: 32105
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        unit_of_measurement: kWh
        device_class: energy_storage
        state_class: measurement
        scale: 0.001
        offset: 0
        precision: 2

      - name: "Marstek 1 AC Voltage"
        unique_id: marstek_1_ac_voltage
        address: 32200
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        unit_of_measurement: V
        device_class: voltage
        state_class: measurement
        scale: 0.1
        offset: 0
        precision: 1

      - name: "Marstek 1 AC Current"
        unique_id: marstek_1_ac_current
        address: 32201
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: int16
        unit_of_measurement: A
        device_class: current
        state_class: measurement
        scale: 0.01
        offset: 0
        precision: 1

      - name: "Marstek 1 AC Power"
        unique_id: marstek_1_ac_power
        address: 32202
        slave: 1
        scan_interval: 10
        input_type: holding
        data_type: int32
        unit_of_measurement: W
        device_class: power
        state_class: measurement
        scale: 1
        offset: 0
        precision: 0

      - name: "Marstek 1 AC Frequency"
        unique_id: marstek_1_ac_frequency
        address: 32204
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        unit_of_measurement: Hz
        device_class: frequency
        state_class: measurement
        scale: 0.01
        offset: 0
        precision: 2

      - name: "Marstek 1 AC Offgrid Voltage"
        unique_id: marstek_1_ac_offgrid_voltage
        address: 32300
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        unit_of_measurement: V
        device_class: voltage
        state_class: measurement
        scale: 0.1
        offset: 0
        precision: 1

      - name: "Marstek 1 AC Offgrid Current"
        unique_id: marstek_1_ac_offgrid_current
        address: 32301
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: int16
        unit_of_measurement: A
        device_class: current
        state_class: measurement
        scale: 0.01
        offset: 0
        precision: 1

      - name: "Marstek 1 AC Offgrid Power"
        unique_id: marstek_1_ac_offgrid_power
        address: 32302
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: int32
        unit_of_measurement: W
        device_class: power
        state_class: measurement
        scale: 1
        offset: 0
        precision: 0

      - name: "Marstek 1 Total Charging Energy"
        unique_id: marstek_1_total_charging_energy
        address: 33000
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint32
        unit_of_measurement: kWh
        device_class: energy
        state_class: total_increasing
        scale: 0.01
        offset: 0
        precision: 2

      - name: "Marstek 1 Total Discharging Energy"
        unique_id: marstek_1_total_discharging_energy
        address: 33002
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint32
        unit_of_measurement: kWh
        device_class: energy
        state_class: total_increasing
        scale: 0.01
        offset: 0
        precision: 2

      - name: "Marstek 1 Daily Charging Energy"
        unique_id: marstek_1_daily_charging_energy
        address: 33004
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint32
        unit_of_measurement: kWh
        device_class: energy
        state_class: total_increasing
        scale: 0.01
        offset: 0
        precision: 2

      - name: "Marstek 1 Daily Discharging Energy"
        unique_id: marstek_1_daily_discharging_energy
        address: 33006
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint32
        unit_of_measurement: kWh
        device_class: energy
        state_class: total_increasing
        scale: 0.01
        offset: 0
        precision: 2

      - name: "Marstek 1 monthly Charging Energy"
        unique_id: marstek_1_monthly_charging_energy
        address: 33008
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint32
        unit_of_measurement: kWh
        device_class: energy
        state_class: total_increasing
        scale: 0.01
        offset: 0
        precision: 2

      - name: "Marstek 1 Monthly Discharging Energy"
        unique_id: marstek_1_monthly_discharging_energy
        address: 33010
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint32
        unit_of_measurement: kWh
        device_class: energy
        state_class: total_increasing
        scale: 0.01
        offset: 0
        precision: 2

      - name: "Marstek 1 Internal Temperature"
        unique_id: marstek_1_internal_temperature
        address: 35000
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: int16
        unit_of_measurement: °C
        device_class: temperature
        state_class: measurement
        scale: 0.1
        offset: 0
        precision: 1

      - name: "Marstek 1 Internal MOS1 Temperature"
        unique_id: marstek_1_internal_mos1_temperature
        address: 35001
        slave: 1
        scan_interval: 600
        input_type: holding
        data_type: int16
        unit_of_measurement: °C
        device_class: temperature
        state_class: measurement
        scale: 0.1
        offset: 0
        precision: 1

      - name: "Marstek 1 Internal MOS2 Temperature"
        unique_id: marstek_1_internal_mos2_temperature
        address: 35002
        slave: 1
        scan_interval: 600
        input_type: holding
        data_type: int16
        unit_of_measurement: °C
        device_class: temperature
        state_class: measurement
        scale: 0.1
        offset: 0
        precision: 1

      - name: "Marstek 1 Max Cell Temperature"
        unique_id: marstek_1_max_cell_temperature
        address: 35010
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: int16
        unit_of_measurement: °C
        device_class: temperature
        state_class: measurement
        scale: 1
        offset: 0
        precision: 0
        # BMS v213 it is suddenly scale 1, BMS v215 it is scale 0.1 again

      - name: "Marstek 1 Min Cell Temperature"
        unique_id: marstek_1_min_cell_temperature
        address: 35011
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: int16
        unit_of_measurement: °C
        device_class: temperature
        state_class: measurement
        scale: 1
        offset: 0
        precision: 0
        # BMS v213 it is suddenly scale 1, BMS v215 it is scale 0.1 again

      - name: "Marstek 1 Inverter State"
        unique_id: marstek_1_inverter_state
        address: 35100
        slave: 1
        scan_interval: 5
        input_type: holding
        data_type: uint16
        state_class: measurement
        # 0 Sleep
        # 1 Stand-By
        # 2 Charge
        # 3 Discharge
        # 4 Backup/Mode or Fault
        # 5 OTA Upgrade
        # 6 Bypass

      # Read 3 at once
      # 35010, unit16, "Marstek 1 Battery Charge Voltage Limit", 0.1, V
      # 35011, unit16, "Marstek 1 Battery Charge Current Limit", 0.1, A
      # 35012, unit16, "Marstek 1 Battery Discharge Current Limit", 0.1, A
      - name: "Marstek 1 Battery Charge Limits"
        unique_id: marstek_1_battery_charge_limits
        address: 35110
        input_type: holding
        data_type: custom
        count: 3
        structure: ">3H"
        scan_interval: 90

      # Possible not correct. Implemented on best effort
      - name: "Marstek 1 Alarm State"
        unique_id: marstek_1_alarm_state
        address: 36000
        scan_interval: 60
        slave: 1
        input_type: holding
        data_type: custom
        count: 2
        structure: ">2H"

      - name: "Marstek 1 Fault State"
        unique_id: marstek_1_fault_state
        address: 36100
        scan_interval: 60
        slave: 1
        input_type: holding
        data_type: custom
        count: 4
        structure: ">4H"

      # 36104 Absent???
      # 37000 always 1
      # 37001 always 0
      # 37002 always 0
      # 37003 always 0
      # 37004 = 32202
      # 37005 = 32104
      # 37006 = 35010 = 35011

      - name: "Marstek 1 Battery Maximum Cell Voltage"
        unique_id: marstek_1_battery_maximum_cell_voltage
        address: 37007
        slave: 1
        scan_interval: 10
        input_type: holding
        data_type: uint16
        unit_of_measurement: "V"
        state_class: measurement
        scale: 0.001
        offset: 0
        precision: 3

      - name: "Marstek 1 Battery Minimum Cell Voltage"
        unique_id: marstek_1_battery_minimum_cell_voltage
        address: 37008
        slave: 1
        scan_interval: 10
        input_type: holding
        data_type: uint16
        unit_of_measurement: "V"
        state_class: measurement
        scale: 0.001
        offset: 0
        precision: 3

      # 37009 llways 0
      # 37010 load balancer ???
      # 37011 mmmqt and 37012= 1 when balancing? maybe trade mode??
      # 37013 8 bytes = 36100
      # 41000 = Device restart, we do not implement, write 0x55AA = restart
      # 41001 = Factory reset, we do not implement, write 0x55AA = reset
      - name: "Marstek 1 Power Limit 800W"
        unique_id: marstek_1_power_limit_800w
        slave: 1
        address: 41010
        input_type: holding
        data_type: uint16
        scan_interval: 60
        scale: 1
        offset: 0
        precision: 0
        # Not implemented, only read

      # 41100 = Modbus address, always 1, we do nothing with this
      # 41200 = Backup function, see switches, we implemented it

      # Only V1 & V2
      - name: "Marstek 1 WiFi SSID"
        unique_id: marstek_1_wifi_ssid
        address: 41500
        slave: 1
        scan_interval: 300
        input_type: holding
        data_type: custom
        count: 16
        structure: ">32s"

      # Only V1 & V2
      # 41516 Last 2 chars of Wifi Password, we do not implement
      - name: "Marstek 1 RS485 Control Mode"
        unique_id: marstek_1_rs485_control_mode
        address: 42000
        slave: 1
        input_type: holding
        data_type: uint16
        scale: 1
        offset: 0
        precision: 0
        # Registers 42000 - 42999 only work when this is set.
        # 0x55AA = Enable
        # 0x55BB = Disable

      - name: "Marstek 1 Force Charge/Discharge Mode"
        unique_id: marstek_1_force_charge_discharge_mode
        address: 42010
        slave: 1
        input_type: holding
        data_type: uint16
        scale: 1
        offset: 0
        precision: 0
        # 0 stop
        # 1 Forces to charge according to 42020 value
        # 2 Forces to discharge according to 42021 value
        # Works as follow:
        # - 42000 write 55AA
        # - 42020 write value or 42021 write value
        # - 42010 set to 1 or 2
        # - 42000 write 55BB = disable

      - name: "Marstek 1 Charge to SOC"
        unique_id: marstek_1_charge_to_soc
        address: 42011
        slave: 1
        input_type: holding
        data_type: uint16
        unit_of_measurement: "%"
        scale: 1
        offset: 0
        precision: 0
        # Overrides 42010
        # Works as follow:
        # - 42000 write 55AA
        # - 42011 write value
        # - 42000 write 55BB = disable

      - name: "Marstek 1 Forcible Charge Power"
        unique_id: marstek_1_forcible_charge_power
        address: 42020
        slave: 1
        input_type: holding
        data_type: uint16
        unit_of_measurement: W
        scale: 1
        offset: 0
        precision: 0

      - name: "Marstek 1 Forcible Discharge Power"
        unique_id: marstek_1_forcible_discharge_power
        address: 42021
        slave: 1
        input_type: holding
        data_type: uint16
        unit_of_measurement: W
        scale: 1
        offset: 0
        precision: 0

      - name: "Marstek 1 User Work Mode"
        unique_id: marstek_1_user_work_mode
        address: 43000
        slave: 1
        scan_interval: 10
        input_type: holding
        data_type: uint16
        scale: 1
        offset: 0
        precision: 0
        # Set to 0 = Manual, see registers 43100-43129
        # Set to 1 = Self consumption, aka Anti-feed
        # Set to 2 = Set to AI mode, after set reverts to 1, still determining what register changes in AI mode

      # 43100-43129 are a set of registes accordint to the following
      # 2 uint16: Weekday, bitmask, high byte = 0, low byte = weekday, bit 0 = monday, bit 7 = sunday.  value 00000001 = monday, 00001001 = monday and thursday, 01100000 = saturday and sunday
      # 4 uint16: Start. Value = 2359 = 23:59, 2101 = 21:01
      # 6 uint16: Stop (see start)
      # 8 int16:  value - is charge, value + is discharge. Range = -2500 to +2500, keep in mind if discharge mode > 800
      # 10 uint16: 0 = disable, 0 = enable

      - name: "Marstek 1 Manual Schedule 1"
        unique_id: marstek_1_manual_schedule_1
        address: 43100
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: custom
        count: 5
        structure: ">HHHhH"

      - name: "Marstek 1 Manual Schedule 2"
        unique_id: marstek_1_manual_schedule_2
        address: 43105
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: custom
        count: 5
        structure: ">HHHhH"

      - name: "Marstek 1 Manual Schedule 3"
        unique_id: marstek_1_manual_schedule_3
        address: 43110
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: custom
        count: 5
        structure: ">HHHhH"

      - name: "Marstek 1 Manual Schedule 4"
        unique_id: marstek_1_manual_schedule_4
        address: 43115
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: custom
        count: 5
        structure: ">HHHhH"

      - name: "Marstek 1 Manual Schedule 5"
        unique_id: marstek_1_manual_schedule_5
        address: 43120
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: custom
        count: 5
        structure: ">HHHhH"

      - name: "Marstek 1 Manual Schedule 6"
        unique_id: marstek_1_manual_schedule_6
        address: 43125
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: custom
        count: 5
        structure: ">HHHhH"

      - name: "Marstek 1 Capacity and Power registers"
        unique_id: marstek_1_capacity_and_power_registers
        address: 44000
        scan_interval: 10
        slave: 1
        input_type: holding
        data_type: custom
        count: 4
        structure: ">4H"
        # 44000 = charging cutoff, implemented with automation
        # 44001 = discharging cutoff, implemented with automation
        # 44002 = max charge power, implemented with automation
        # 44003 = max discharge power, implemented with automation

      - name: "Marstek 1 Grid standard"
        unique_id: marstek_1_grid_standard
        address: 44100
        slave: 1
        scan_interval: 300
        input_type: holding
        data_type: uint16
        scale: 1
        offset: 0
        precision: 0
        # 0 Auto (220-240V, 50/60Hz)
        # 1 EN50549
        # 2 NL
        # 3 DE
        # 4 AT
        # 5 UK
        # 6 ES
        # 7 PL
        # 8 IT
        # 9 CN

    # 45603 Unknown
    # 45604 Unknown

    switches:
      - name: "Marstek 1 Device Restart"
        unique_id: marstek_1_device_restart
        slave: 1
        address: 41000
        command_on: 21930
        command_off: 0
        write_type: holding
        verify:
          address: 41000
          delay: 10
          input_type: holding
          state_on: 21930
          state_off: 0

      - name: "Marstek 1 Factory Reset"
        unique_id: marstek_1_factory_reset
        slave: 1
        address: 41001
        command_on: 21930
        command_off: 0
        write_type: holding
        verify:
          address: 41001
          delay: 10
          input_type: holding
          state_on: 21930
          state_off: 0

      #      - name: "Marstek 1 Power Restriction (800W)"
      #        unique_id: marstek_1_power_restriction
      #        slave: 1
      #        address: 41010
      #        command_on: 1
      #        command_off: 0
      #        write_type: holding
      #        verify:
      #          address: 41010
      #          delay: 30
      #          input_type: holding
      #          state_on: 1
      #          state_off: 0

      - name: "Marstek 1 Backup Enabled"
        unique_id: marstek_1_backup_enabled
        slave: 1
        address: 41200
        command_on: 0
        command_off: 1
        write_type: holding
        verify:
          address: 41200
          delay: 10
          input_type: holding
          state_on: 0
          state_off: 1

# ------------
# INPUT NUMBER
# ------------
input_number:
  marstek_1_discharging_charging_power:
    name: "Marstek 1 (dis)charging power"
    min: -2500
    max: 2500
    step: 50
    unit_of_measurement: W
    mode: slider

  marstek_1_set_max_discharging_power:
    name: "Marstek 1 Set Maximum discharging power"
    min: 50
    max: 2500
    step: 10
    unit_of_measurement: W
    mode: box

  marstek_1_set_max_charging_power:
    name: "Marstek 1 Set Maximum charging power"
    min: 50
    max: 2500
    step: 50
    unit_of_measurement: W
    mode: box

  marstek_1_set_battery_min_soc:
    name: "Marstek 1 Set Battery minimum SOC (Discharge)"
    min: 11
    max: 25
    step: 0.1
    unit_of_measurement: "%"
    mode: box

  marstek_1_set_battery_max_soc:
    name: "Marstek 1 Set Battery maximum SOC (Charge)"
    min: 75
    max: 100
    step: 0.1
    unit_of_measurement: "%"
    mode: box

  marstek_1_manual_schedule_1_power:
    name: Marstek 1 Manual Schedule 1 Power
    min: -2500
    max: 2500
    step: 10
    unit_of_measurement: W
    mode: slider
    icon: mdi:power-plug-battery-outline

  marstek_1_manual_schedule_2_power:
    name: Marstek 1 Manual Schedule 2 Power
    min: -2500
    max: 2500
    step: 10
    unit_of_measurement: W
    mode: slider
    icon: mdi:power-plug-battery-outline

  marstek_1_manual_schedule_3_power:
    name: Marstek 1 Manual Schedule 3 Power
    min: -2500
    max: 2500
    step: 10
    unit_of_measurement: W
    mode: slider
    icon: mdi:power-plug-battery-outline

  marstek_1_manual_schedule_4_power:
    name: Marstek 1 Manual Schedule 4 Power
    min: -2500
    max: 2500
    step: 10
    unit_of_measurement: W
    mode: slider
    icon: mdi:power-plug-battery-outline

  marstek_1_manual_schedule_5_power:
    name: Marstek 1 Manual Schedule 5 Power
    min: -2500
    max: 2500
    step: 10
    unit_of_measurement: W
    mode: slider
    icon: mdi:power-plug-battery-outline

  marstek_1_manual_schedule_6_power:
    name: Marstek 1 Manual Schedule 6 Power
    min: -2500
    max: 2500
    step: 10
    unit_of_measurement: W
    mode: slider
    icon: mdi:power-plug-battery-outline

# ------------
# INPUT SELECT
# ------------
input_select:
  marstek_1_user_work_mode_input_select:
    name: Marstek 1 User Work Mode
    options:
      - "Manual"
      - "Anti-Feed"
      - "Trade"

# ------------
# INPUT BUTTON
# ------------
input_button:
  marstek_1_manual_schedule_1_set:
    name: Marstek 1 Schedule 1 set
    icon: mdi:account-switch-outline
  marstek_1_manual_schedule_2_set:
    name: Marstek 1 Schedule 2 set
    icon: mdi:account-switch-outline
  marstek_1_manual_schedule_3_set:
    name: Marstek 1 Schedule 3 set
    icon: mdi:account-switch-outline
  marstek_1_manual_schedule_4_set:
    name: Marstek 1 Schedule 4 set
    icon: mdi:account-switch-outline
  marstek_1_manual_schedule_5_set:
    name: Marstek 1 Schedule 5 set
    icon: mdi:account-switch-outline
  marstek_1_manual_schedule_6_set:
    name: Marstek 1 Schedule 6 set
    icon: mdi:account-switch-outline

# -------------
# INPUT BOOLEAN
# -------------
input_boolean:
  marstek_1_manual_schedule_1_enabled:
    name: Marstek 1 Manual Schedule 1 Enabled
    icon: mdi:calendar-check

  marstek_1_manual_schedule_2_enabled:
    name: Marstek 1 Manual Schedule 2 Enabled
    icon: mdi:calendar-check

  marstek_1_manual_schedule_3_enabled:
    name: Marstek 1 Manual Schedule 3 Enabled
    icon: mdi:calendar-check

  marstek_1_manual_schedule_4_enabled:
    name: Marstek 1 Manual Schedule 4 Enabled
    icon: mdi:calendar-check

  marstek_1_manual_schedule_5_enabled:
    name: Marstek 1 Manual Schedule 5 Enabled
    icon: mdi:calendar-check

  marstek_1_manual_schedule_6_enabled:
    name: Marstek 1 Manual Schedule 6 Enabled
    icon: mdi:calendar-check

  marstek_1_manual_schedule_1_schedule_sunday:
    name: Marstek 1 Manual Schedule 1 Sunday
    icon: mdi:alpha-s-box

  marstek_1_manual_schedule_1_schedule_monday:
    name: Marstek 1 Manual Schedule 1 Monday
    icon: mdi:alpha-m-box

  marstek_1_manual_schedule_1_schedule_tuesday:
    name: Marstek 1 Manual Schedule 1 Tuesday
    icon: mdi:alpha-t-box

  marstek_1_manual_schedule_1_schedule_wednesday:
    name: Marstek 1 Manual Schedule 1 Wednesday
    icon: mdi:alpha-w-box

  marstek_1_manual_schedule_1_schedule_thursday:
    name: Marstek 1 Manual Schedule 1 Thursday
    icon: mdi:alpha-t-box-outline

  marstek_1_manual_schedule_1_schedule_friday:
    name: Marstek 1 Manual Schedule 1 Friday
    icon: mdi:alpha-f-box

  marstek_1_manual_schedule_1_schedule_saturday:
    name: Marstek 1 Manual Schedule 1 Saturday
    icon: mdi:alpha-s-box-outline

  marstek_1_manual_schedule_2_schedule_sunday:
    name: Marstek 1 Manual Schedule 2 Sunday
    icon: mdi:alpha-s-box

  marstek_1_manual_schedule_2_schedule_monday:
    name: Marstek 1 Manual Schedule 2 Monday
    icon: mdi:alpha-m-box

  marstek_1_manual_schedule_2_schedule_tuesday:
    name: Marstek 1 Manual Schedule 2 Tuesday
    icon: mdi:alpha-t-box

  marstek_1_manual_schedule_2_schedule_wednesday:
    name: Marstek 1 Manual Schedule 2 Wednesday
    icon: mdi:alpha-w-box

  marstek_1_manual_schedule_2_schedule_thursday:
    name: Marstek 1 Manual Schedule 2 Thursday
    icon: mdi:alpha-t-box-outline

  marstek_1_manual_schedule_2_schedule_friday:
    name: Marstek 1 Manual Schedule 2 Friday
    icon: mdi:alpha-f-box

  marstek_1_manual_schedule_2_schedule_saturday:
    name: Marstek 1 Manual Schedule 2 Saturday
    icon: mdi:alpha-s-box-outline

  marstek_1_manual_schedule_3_schedule_sunday:
    name: Marstek 1 Manual Schedule 3 Sunday
    icon: mdi:alpha-s-box

  marstek_1_manual_schedule_3_schedule_monday:
    name: Marstek 1 Manual Schedule 3 Monday
    icon: mdi:alpha-m-box

  marstek_1_manual_schedule_3_schedule_tuesday:
    name: Marstek 1 Manual Schedule 3 Tuesday
    icon: mdi:alpha-t-box

  marstek_1_manual_schedule_3_schedule_wednesday:
    name: Marstek 1 Manual Schedule 3 Wednesday
    icon: mdi:alpha-w-box

  marstek_1_manual_schedule_3_schedule_thursday:
    name: Marstek 1 Manual Schedule 3 Thursday
    icon: mdi:alpha-t-box-outline

  marstek_1_manual_schedule_3_schedule_friday:
    name: Marstek 1 Manual Schedule 3 Friday
    icon: mdi:alpha-f-box

  marstek_1_manual_schedule_3_schedule_saturday:
    name: Marstek 1 Manual Schedule 3 Saturday
    icon: mdi:alpha-s-box-outline

  marstek_1_manual_schedule_4_schedule_sunday:
    name: Marstek 1 Manual Schedule 4 Sunday
    icon: mdi:alpha-s-box

  marstek_1_manual_schedule_4_schedule_monday:
    name: Marstek 1 Manual Schedule 4 Monday
    icon: mdi:alpha-m-box

  marstek_1_manual_schedule_4_schedule_tuesday:
    name: Marstek 1 Manual Schedule 4 Tuesday
    icon: mdi:alpha-t-box

  marstek_1_manual_schedule_4_schedule_wednesday:
    name: Marstek 1 Manual Schedule 4 Wednesday
    icon: mdi:alpha-w-box

  marstek_1_manual_schedule_4_schedule_thursday:
    name: Marstek 1 Manual Schedule 4 Thursday
    icon: mdi:alpha-t-box-outline

  marstek_1_manual_schedule_4_schedule_friday:
    name: Marstek 1 Manual Schedule 4 Friday
    icon: mdi:alpha-f-box

  marstek_1_manual_schedule_4_schedule_saturday:
    name: Marstek 1 Manual Schedule 4 Saturday
    icon: mdi:alpha-s-box-outline

  marstek_1_manual_schedule_5_schedule_sunday:
    name: Marstek 1 Manual Schedule 5 Sunday
    icon: mdi:alpha-s-box

  marstek_1_manual_schedule_5_schedule_monday:
    name: Marstek 1 Manual Schedule 5 Monday
    icon: mdi:alpha-m-box

  marstek_1_manual_schedule_5_schedule_tuesday:
    name: Marstek 1 Manual Schedule 5 Tuesday
    icon: mdi:alpha-t-box

  marstek_1_manual_schedule_5_schedule_wednesday:
    name: Marstek 1 Manual Schedule 5 Wednesday
    icon: mdi:alpha-w-box

  marstek_1_manual_schedule_5_schedule_thursday:
    name: Marstek 1 Manual Schedule 5 Thursday
    icon: mdi:alpha-t-box-outline

  marstek_1_manual_schedule_5_schedule_friday:
    name: Marstek 1 Manual Schedule 5 Friday
    icon: mdi:alpha-f-box

  marstek_1_manual_schedule_5_schedule_saturday:
    name: Marstek 1 Manual Schedule 5 Saturday
    icon: mdi:alpha-s-box-outline

  marstek_1_manual_schedule_6_schedule_sunday:
    name: Marstek 1 Manual Schedule 6 Sunday
    icon: mdi:alpha-s-box

  marstek_1_manual_schedule_6_schedule_monday:
    name: Marstek 1 Manual Schedule 6 Monday
    icon: mdi:alpha-m-box

  marstek_1_manual_schedule_6_schedule_tuesday:
    name: Marstek 1 Manual Schedule 6 Tuesday
    icon: mdi:alpha-t-box

  marstek_1_manual_schedule_6_schedule_wednesday:
    name: Marstek 1 Manual Schedule 6 Wednesday
    icon: mdi:alpha-w-box

  marstek_1_manual_schedule_6_schedule_thursday:
    name: Marstek 1 Manual Schedule 6 Thursday
    icon: mdi:alpha-t-box-outline

  marstek_1_manual_schedule_6_schedule_friday:
    name: Marstek 1 Manual Schedule 6 Friday
    icon: mdi:alpha-f-box

  marstek_1_manual_schedule_6_schedule_saturday:
    name: Marstek 1 Manual Schedule 6 Saturday
    icon: mdi:alpha-s-box-outline

# --------------
# INPUT DATETIME
# --------------
input_datetime:
  marstek_1_manual_schedule_1_schedule_start:
    name: Marstek 1 Manual Schedule 1 Start time
    icon: mdi:clock-start
    has_date: false
    has_time: true

  marstek_1_manual_schedule_1_schedule_end:
    name: Marstek 1 Manual Schedule 1 End time
    icon: mdi:clock-end
    has_date: false
    has_time: true

  marstek_1_manual_schedule_2_schedule_start:
    name: Marstek 1 Manual Schedule 2 Start time
    icon: mdi:clock-start
    has_date: false
    has_time: true

  marstek_1_manual_schedule_2_schedule_end:
    name: Marstek 1 Manual Schedule 2 End time
    icon: mdi:clock-end
    has_date: false
    has_time: true

  marstek_1_manual_schedule_3_schedule_start:
    name: Marstek 1 Manual Schedule 3 Start time
    icon: mdi:clock-start
    has_date: false
    has_time: true

  marstek_1_manual_schedule_3_schedule_end:
    name: Marstek 1 Manual Schedule 3 End time
    icon: mdi:clock-end
    has_date: false
    has_time: true

  marstek_1_manual_schedule_4_schedule_start:
    name: Marstek 1 Manual Schedule 4 Start time
    icon: mdi:clock-start
    has_date: false
    has_time: true

  marstek_1_manual_schedule_4_schedule_end:
    name: Marstek 1 Manual Schedule 4 End time
    icon: mdi:clock-end
    has_date: false
    has_time: true

  marstek_1_manual_schedule_5_schedule_start:
    name: Marstek 1 Manual Schedule 5 Start time
    icon: mdi:clock-start
    has_date: false
    has_time: true

  marstek_1_manual_schedule_5_schedule_end:
    name: Marstek 1 Manual Schedule 5 End time
    icon: mdi:clock-end
    has_date: false
    has_time: true

  marstek_1_manual_schedule_6_schedule_start:
    name: Marstek 1 Manual Schedule 6 Start time
    icon: mdi:clock-start
    has_date: false
    has_time: true

  marstek_1_manual_schedule_6_schedule_end:
    name: Marstek 1 Manual Schedule 6 End time
    icon: mdi:clock-end
    has_date: false
    has_time: true

# -------
# SCRIPTS
# -------
script:
  marstek_1_set_forcible_charge:
    sequence:
      - choose:
          - conditions:
              - condition: numeric_state
                entity_id: input_number.marstek_1_discharging_charging_power
                above: -1
                below: 1
            sequence:
              - action: modbus.write_register
                data:
                  hub: MarstekVenus1
                  address: 42010
                  slave: 1
                  value: 0
              - action: modbus.write_register
                data:
                  hub: MarstekVenus1
                  address: 42020
                  slave: 1
                  value: 0
              - action: modbus.write_register
                data:
                  hub: MarstekVenus1
                  address: 42021
                  slave: 1
                  value: 0
          - conditions:
              - condition: numeric_state
                entity_id: input_number.marstek_1_discharging_charging_power
                above: -2501
                below: -10
            sequence:
              - action: modbus.write_register
                data:
                  hub: MarstekVenus1
                  address: 42021
                  slave: 1
                  value: "{{states('input_number.marstek_1_discharging_charging_power')|int|abs}}"
              - action: modbus.write_register
                data:
                  hub: MarstekVenus1
                  address: 42010
                  slave: 1
                  value: 2
          - conditions:
              - condition: numeric_state
                entity_id: input_number.marstek_1_discharging_charging_power
                above: 10
                below: 2501
            sequence:
              - action: modbus.write_register
                data:
                  hub: MarstekVenus1
                  address: 42020
                  slave: 1
                  value: "{{states('input_number.marstek_1_discharging_charging_power')|int|abs}}"
              - action: modbus.write_register
                data:
                  hub: MarstekVenus1
                  address: 42010
                  slave: 1
                  value: 1
    alias: Marstek 1 Set Forcible Charge
    description: ""
    icon: mdi:battery-charging-40

  # index[0] uint16: Weekday, bitmask, high byte = 0, low byte = weekday, bit 0 = monday, bit 7 = sunday.  value 00000001 = monday, 00001001 = monday and thursday, 01100000 = saturday and sunday
  # index[1] uint16: Start. Value = 2359 = 23:59, 2101 = 21:01
  # index[2] uint16: Stop (see start)
  # index[3] int16:  value - is charge, value + is discharge. Range = -2500 to +2500, keep in mind if discharge mode > 800
  # index[4] uint16: 0 = disable, 1 = enable
  marstek_1_read_write_modbus_schedule:
    fields:
      marstek_register:
        description: Register to read or write
        example: schedule_1
        default: schedule_1
      marstek_action:
        description: Action to perform on register
        example: read
        default: read
    variables:
      script_action: "{{marstek_action}}"
      script_version: "marstek_1_manual"
      modbus_register: "sensor.{{script_version}}_{{marstek_register}}"
      schedule_end: "{{script_version}}_{{marstek_register}}_schedule_end"
      schedule_start: "{{script_version}}_{{marstek_register}}_schedule_start"
      schedule_sunday: "{{script_version}}_{{marstek_register}}_schedule_sunday"
      schedule_monday: "{{script_version}}_{{marstek_register}}_schedule_monday"
      schedule_tuesday: "{{script_version}}_{{marstek_register}}_schedule_tuesday"
      schedule_wednesday: "{{script_version}}_{{marstek_register}}_schedule_wednesday"
      schedule_thursday: "{{script_version}}_{{marstek_register}}_schedule_thursday"
      schedule_friday: "{{script_version}}_{{marstek_register}}_schedule_friday"
      schedule_saturday: "{{script_version}}_{{marstek_register}}_schedule_saturday"
      schedule_enabled: "{{script_version}}_{{marstek_register}}_enabled"
      schedule_power: "{{script_version}}_{{marstek_register}}_power"
      start_register: "{{ 43100 + ((marstek_register.split('_')[1] | int(0) - 1) * 5) }}"
      register_weekday: "{{start_register | int + 0 | int }}"
      register_start: "{{start_register | int + 1 | int }}"
      register_end: "{{start_register | int + 2 | int }}"
      register_power: "{{start_register | int + 3 | int }}"
      register_enabled: "{{start_register | int + 4 | int }}"
    alias: Marstek 1 Read Write Modbus Schedule
    description: "Reads or Writes Modbus registes to schedule varables"
    sequence:
      - choose:
          conditions:
            - condition: template
              value_template: "{{marstek_action=='read'}}"
          sequence:
            - action: input_number.set_value
              data:
                value: "{{states(modbus_register).split(',')[3] | int(0)}}"
              target:
                entity_id: "input_number.{{schedule_power}}"
            # start time
            - action: input_datetime.set_datetime
              data:
                time: >
                  {% set hours= (states(modbus_register).split(',')[1] | int / 100 | round(0)) | int %}
                  {% set minutes= (states(modbus_register).split(',')[1] | int) - (hours * 100) | int %}
                  {{ ((hours|int * 3600) + (minutes|int * 60) | int)  |timestamp_custom('%H:%M', false) }}
              target:
                entity_id: "input_datetime.{{schedule_start}}"
            # stop time
            - action: input_datetime.set_datetime
              data:
                time: >
                  {% set hours= (states(modbus_register).split(',')[2] | int / 100 | round(0)) | int %}
                  {% set minutes= (states(modbus_register).split(',')[2] | int) - (hours * 100) | int %}
                  {{ ((hours|int * 3600) + (minutes|int * 60) | int)  |timestamp_custom('%H:%M', false) }}
              target:
                entity_id: "input_datetime.{{schedule_end}}"
            # Day monday
            - if:
                - condition: template
                  value_template: "{{(states(modbus_register).split(',')[0] | int | bitwise_and(0x01)) == 0}}"
                  enabled: true
              then:
                - action: input_boolean.turn_off
                  target:
                    entity_id: "input_boolean.{{schedule_monday}}"
              else:
                - action: input_boolean.turn_on
                  target:
                    entity_id: "input_boolean.{{schedule_monday}}"
            # day tuesday
            - if:
                - condition: template
                  value_template: "{{(states(modbus_register).split(',')[0] | int | bitwise_and(0x02)) == 0}}"
                  enabled: true
              then:
                - action: input_boolean.turn_off
                  target:
                    entity_id: "input_boolean.{{schedule_tuesday}}"
              else:
                - action: input_boolean.turn_on
                  target:
                    entity_id: "input_boolean.{{schedule_tuesday}}"
            # day wednesday
            - if:
                - condition: template
                  value_template: "{{(states(modbus_register).split(',')[0] | int | bitwise_and(0x04)) == 0}}"
                  enabled: true
              then:
                - action: input_boolean.turn_off
                  target:
                    entity_id: "input_boolean.{{schedule_wednesday}}"
              else:
                - action: input_boolean.turn_on
                  target:
                    entity_id: "input_boolean.{{schedule_wednesday}}"
            # day thursday
            - if:
                - condition: template
                  value_template: "{{(states(modbus_register).split(',')[0] | int | bitwise_and(0x08)) == 0}}"
                  enabled: true
              then:
                - action: input_boolean.turn_off
                  target:
                    entity_id: "input_boolean.{{schedule_thursday}}"
              else:
                - action: input_boolean.turn_on
                  target:
                    entity_id: "input_boolean.{{schedule_thursday}}"
            # day friday
            - if:
                - condition: template
                  value_template: "{{(states(modbus_register).split(',')[0] | int | bitwise_and(0x10)) == 0}}"
                  enabled: true
              then:
                - action: input_boolean.turn_off
                  target:
                    entity_id: "input_boolean.{{schedule_friday}}"
              else:
                - action: input_boolean.turn_on
                  target:
                    entity_id: "input_boolean.{{schedule_friday}}"
            # day saturday
            - if:
                - condition: template
                  value_template: "{{(states(modbus_register).split(',')[0] | int | bitwise_and(0x20)) == 0}}"
                  enabled: true
              then:
                - action: input_boolean.turn_off
                  target:
                    entity_id: "input_boolean.{{schedule_saturday}}"
              else:
                - action: input_boolean.turn_on
                  target:
                    entity_id: "input_boolean.{{schedule_saturday}}"
            # day sunday
            - if:
                - condition: template
                  value_template: "{{(states(modbus_register).split(',')[0] | int | bitwise_and(0x40)) == 0}}"
                  enabled: true
              then:
                - action: input_boolean.turn_off
                  target:
                    entity_id: "input_boolean.{{schedule_sunday}}"
              else:
                - action: input_boolean.turn_on
                  target:
                    entity_id: "input_boolean.{{schedule_sunday}}"
            # Enabled
            - if:
                - condition: template
                  value_template: "{{(states(modbus_register).split(',')[4] | int) == 0}}"
                  enabled: true
              then:
                - action: input_boolean.turn_off
                  target:
                    entity_id: "input_boolean.{{schedule_enabled}}"
              else:
                - action: input_boolean.turn_on
                  target:
                    entity_id: "input_boolean.{{schedule_enabled}}"
      - choose:
          conditions:
            - condition: template
              value_template: "{{marstek_action=='write'}}"
            - condition: template
              value_template: "{{ (((states('input_boolean.'+schedule_enabled) == 'on') | int) == ((states(modbus_register).split(',')[4]) | int)) == false }}"
          sequence:
            - action: modbus.write_register
              data:
                hub: MarstekVenus1
                address: "{{register_weekday}}"
                slave: 1
                value:
                  "{{ ((((states('input_boolean.' + schedule_monday)=='on') | int) * 0x40) +
                  (((states('input_boolean.' + schedule_tuesday)=='on') | int) * 0x20) +
                  (((states('input_boolean.' + schedule_wednesday)=='on') | int) * 0x10) +
                  (((states('input_boolean.' + schedule_thursday)=='on') | int) * 0x08) +
                  (((states('input_boolean.' + schedule_friday)=='on') | int) * 0x04) +
                  (((states('input_boolean.' + schedule_saturday)=='on') | int) * 0x02) +
                  (((states('input_boolean.' + schedule_sunday)=='on') | int) * 0x01)) | abs }}"
            - action: modbus.write_register
              data:
                hub: MarstekVenus1
                address: "{{register_start}}"
                slave: 1
                value: "{{ states('input_datetime.'+schedule_start).split(':')[0] | int * 100 + states('input_datetime.'+schedule_start).split(':')[1] | int | abs}}"
            - action: modbus.write_register
              data:
                hub: MarstekVenus1
                address: "{{register_end}}"
                slave: 1
                value: "{{ states('input_datetime.'+schedule_end).split(':')[0] | int * 100 + states('input_datetime.'+schedule_end).split(':')[1] | int | abs }}"
            - action: modbus.write_register
              data:
                hub: MarstekVenus1
                address: "{{register_power}}"
                slave: 1
                value: "{{ states('input_number.' + schedule_power) | int | bitwise_and(0xffff) }}"
            - action: modbus.write_register
              data:
                hub: MarstekVenus1
                address: "{{register_enabled}}"
                slave: 1
                value: "{{ (states('input_boolean.'+schedule_enabled) == 'on') | int }}"

# -----------
# AUTOMATIONS
# -----------
automation:
  - alias: Marstek 1 Sync Modbus with Schedule 1
    description: Sync Modbus sensor with Schedule 1
    triggers:
      - trigger: state
        entity_id:
          - sensor.marstek_1_manual_schedule_1
        id: change_marstek_1_schedule_1_helpers
      - trigger: state
        entity_id:
          - input_button.marstek_1_manual_schedule_1_set
        #          - input_boolean.marstek_1_manual_schedule_1_enabled
        #          - input_boolean.marstek_1_manual_schedule_1_schedule_sunday
        #          - input_boolean.marstek_1_manual_schedule_1_schedule_monday
        #          - input_boolean.marstek_1_manual_schedule_1_schedule_tuesday
        #          - input_boolean.marstek_1_manual_schedule_1_schedule_wednesday
        #          - input_boolean.marstek_1_manual_schedule_1_schedule_thursday
        #          - input_boolean.marstek_1_manual_schedule_1_schedule_friday
        #          - input_boolean.marstek_1_manual_schedule_1_schedule_saturday
        #          - input_datetime.marstek_1_manual_schedule_1_schedule_start
        #          - input_datetime.marstek_1_manual_schedule_1_schedule_end
        id: change_marstek_1_schedule_1_modbus
    conditions: []
    actions:
      - choose:
          - conditions:
              - condition: trigger
                id: change_marstek_1_schedule_1_helpers
            sequence:
              - sequence:
                  - action: script.marstek_1_read_write_modbus_schedule
                    data:
                      marstek_register: schedule_1
                      marstek_action: read
          - conditions:
              - condition: trigger
                id: change_marstek_1_schedule_1_modbus
            sequence:
              - sequence:
                  - action: script.marstek_1_read_write_modbus_schedule
                    data:
                      marstek_register: schedule_1
                      marstek_action: write
    mode: single

  - alias: Marstek 1 Sync Modbus with Schedule 2
    description: Sync Modbus sensor with Schedule 2
    triggers:
      - trigger: state
        entity_id:
          - sensor.marstek_1_manual_schedule_2
        id: change_marstek_1_schedule_2_helpers
      - trigger: state
        entity_id:
          - input_button.marstek_1_manual_schedule_2_set
        #          - input_boolean.marstek_1_manual_schedule_2_enabled
        #          - input_boolean.marstek_1_manual_schedule_2_schedule_sunday
        #          - input_boolean.marstek_1_manual_schedule_2_schedule_monday
        #          - input_boolean.marstek_1_manual_schedule_2_schedule_tuesday
        #          - input_boolean.marstek_1_manual_schedule_2_schedule_wednesday
        #          - input_boolean.marstek_1_manual_schedule_2_schedule_thursday
        #          - input_boolean.marstek_1_manual_schedule_2_schedule_friday
        #          - input_boolean.marstek_1_manual_schedule_2_schedule_saturday
        #          - input_datetime.marstek_1_manual_schedule_2_schedule_start
        #          - input_datetime.marstek_1_manual_schedule_2_schedule_end
        id: change_marstek_1_schedule_2_modbus
    conditions: []
    actions:
      - choose:
          - conditions:
              - condition: trigger
                id: change_marstek_1_schedule_2_helpers
            sequence:
              - sequence:
                  - action: script.marstek_1_read_write_modbus_schedule
                    data:
                      marstek_register: schedule_2
                      marstek_action: read
          - conditions:
              - condition: trigger
                id: change_marstek_1_schedule_2_modbus
            sequence:
              - sequence:
                  - action: script.marstek_1_read_write_modbus_schedule
                    data:
                      marstek_register: schedule_2
                      marstek_action: write
    mode: single

  - alias: Marstek 1 Sync Modbus with Schedule 3
    description: Sync Modbus sensor with Schedule 3
    triggers:
      - trigger: state
        entity_id:
          - sensor.marstek_1_manual_schedule_3
        id: change_marstek_1_schedule_3_helpers
      - trigger: state
        entity_id:
          - input_button.marstek_1_manual_schedule_3_set
        #          - input_boolean.marstek_1_manual_schedule_3_enabled
        #          - input_boolean.marstek_1_manual_schedule_3_schedule_sunday
        #          - input_boolean.marstek_1_manual_schedule_3_schedule_monday
        #          - input_boolean.marstek_1_manual_schedule_3_schedule_tuesday
        #          - input_boolean.marstek_1_manual_schedule_3_schedule_wednesday
        #          - input_boolean.marstek_1_manual_schedule_3_schedule_thursday
        #          - input_boolean.marstek_1_manual_schedule_3_schedule_friday
        #          - input_boolean.marstek_1_manual_schedule_3_schedule_saturday
        #          - input_datetime.marstek_1_manual_schedule_3_schedule_start
        #          - input_datetime.marstek_1_manual_schedule_3_schedule_end
        id: change_marstek_1_schedule_3_modbus
    conditions: []
    actions:
      - choose:
          - conditions:
              - condition: trigger
                id: change_marstek_1_schedule_3_helpers
            sequence:
              - sequence:
                  - action: script.marstek_1_read_write_modbus_schedule
                    data:
                      marstek_register: schedule_3
                      marstek_action: read
          - conditions:
              - condition: trigger
                id: change_marstek_1_schedule_3_modbus
            sequence:
              - sequence:
                  - action: script.marstek_1_read_write_modbus_schedule
                    data:
                      marstek_register: schedule_3
                      marstek_action: write
    mode: single

  - alias: Marstek 1 Sync Modbus with Schedule 4
    description: Sync Modbus sensor with Schedule 4
    triggers:
      - trigger: state
        entity_id:
          - sensor.marstek_1_manual_schedule_4
        id: change_marstek_1_schedule_4_helpers
      - trigger: state
        entity_id:
          - input_button.marstek_1_manual_schedule_4_set
        #          - input_boolean.marstek_1_manual_schedule_4_enabled
        #          - input_boolean.marstek_1_manual_schedule_4_schedule_sunday
        #          - input_boolean.marstek_1_manual_schedule_4_schedule_monday
        #          - input_boolean.marstek_1_manual_schedule_4_schedule_tuesday
        #          - input_boolean.marstek_1_manual_schedule_4_schedule_wednesday
        #          - input_boolean.marstek_1_manual_schedule_4_schedule_thursday
        #          - input_boolean.marstek_1_manual_schedule_4_schedule_friday
        #          - input_boolean.marstek_1_manual_schedule_4_schedule_saturday
        #          - input_datetime.marstek_1_manual_schedule_4_schedule_start
        #          - input_datetime.marstek_1_manual_schedule_4_schedule_end
        id: change_marstek_1_schedule_4_modbus
    conditions: []
    actions:
      - choose:
          - conditions:
              - condition: trigger
                id: change_marstek_1_schedule_4_helpers
            sequence:
              - sequence:
                  - action: script.marstek_1_read_write_modbus_schedule
                    data:
                      marstek_register: schedule_4
                      marstek_action: read
          - conditions:
              - condition: trigger
                id: change_marstek_1_schedule_4_modbus
            sequence:
              - sequence:
                  - action: script.marstek_1_read_write_modbus_schedule
                    data:
                      marstek_register: schedule_4
                      marstek_action: write
    mode: single

  - alias: Marstek 1 Sync Modbus with Schedule 5
    description: Sync Modbus sensor with Schedule 5
    triggers:
      - trigger: state
        entity_id:
          - sensor.marstek_1_manual_schedule_5
        id: change_marstek_1_schedule_5_helpers
      - trigger: state
        entity_id:
          - input_button.marstek_1_manual_schedule_5_set
        #          - input_boolean.marstek_1_manual_schedule_5_enabled
        #          - input_boolean.marstek_1_manual_schedule_5_schedule_sunday
        #          - input_boolean.marstek_1_manual_schedule_5_schedule_monday
        #          - input_boolean.marstek_1_manual_schedule_5_schedule_tuesday
        #          - input_boolean.marstek_1_manual_schedule_5_schedule_wednesday
        #          - input_boolean.marstek_1_manual_schedule_5_schedule_thursday
        #          - input_boolean.marstek_1_manual_schedule_5_schedule_friday
        #          - input_boolean.marstek_1_manual_schedule_5_schedule_saturday
        #          - input_datetime.marstek_1_manual_schedule_5_schedule_start
        #          - input_datetime.marstek_1_manual_schedule_5_schedule_end
        id: change_marstek_1_schedule_5_modbus
    conditions: []
    actions:
      - choose:
          - conditions:
              - condition: trigger
                id: change_marstek_1_schedule_5_helpers
            sequence:
              - sequence:
                  - action: script.marstek_1_read_write_modbus_schedule
                    data:
                      marstek_register: schedule_5
                      marstek_action: read
          - conditions:
              - condition: trigger
                id: change_marstek_1_schedule_5_modbus
            sequence:
              - sequence:
                  - action: script.marstek_1_read_write_modbus_schedule
                    data:
                      marstek_register: schedule_5
                      marstek_action: write
    mode: single

  - alias: Marstek 1 Sync Modbus with Schedule 6
    description: Sync Modbus sensor with Schedule 6
    triggers:
      - trigger: state
        entity_id:
          - sensor.marstek_1_manual_schedule_6
        id: change_marstek_1_schedule_6_helpers
      - trigger: state
        entity_id:
          - input_button.marstek_1_manual_schedule_6_set
        #          - input_boolean.marstek_1_manual_schedule_6_enabled
        #          - input_boolean.marstek_1_manual_schedule_6_schedule_sunday
        #          - input_boolean.marstek_1_manual_schedule_6_schedule_monday
        #          - input_boolean.marstek_1_manual_schedule_6_schedule_tuesday
        #          - input_boolean.marstek_1_manual_schedule_6_schedule_wednesday
        #          - input_boolean.marstek_1_manual_schedule_6_schedule_thursday
        #          - input_boolean.marstek_1_manual_schedule_6_schedule_friday
        #          - input_boolean.marstek_1_manual_schedule_6_schedule_saturday
        #          - input_datetime.marstek_1_manual_schedule_6_schedule_start
        #          - input_datetime.marstek_1_manual_schedule_6_schedule_end
        id: change_marstek_1_schedule_6_modbus
    conditions: []
    actions:
      - choose:
          - conditions:
              - condition: trigger
                id: change_marstek_1_schedule_6_helpers
            sequence:
              - sequence:
                  - action: script.marstek_1_read_write_modbus_schedule
                    data:
                      marstek_register: schedule_6
                      marstek_action: read
          - conditions:
              - condition: trigger
                id: change_marstek_1_schedule_6_modbus
            sequence:
              - sequence:
                  - action: script.marstek_1_read_write_modbus_schedule
                    data:
                      marstek_register: schedule_6
                      marstek_action: write
    mode: single

  - id: marstek_1_sync_modbus_and_input_select
    alias: "Marstek 1 Sync Modbus and Input Select"
    description: "sync modbus sensor with input select"
    mode: single
    triggers:
      - trigger: state
        entity_id:
          - sensor.marstek_1_user_work_mode
        id: sensor_marstek_1_to_input_select
      - trigger: state
        entity_id:
          - input_select.marstek_1_user_work_mode_input_select
        id: input_select_to_sensor_marstek_1
    conditions: []
    actions:
      - choose:
          - conditions:
              - condition: trigger
                id:
                  - sensor_marstek_1_to_input_select
            sequence:
              - action: input_select.select_option
                metadata: {}
                data:
                  option: >
                    {% if states('sensor.marstek_1_user_work_mode') | int == 0 %}
                      Manual
                    {% elif states('sensor.marstek_1_user_work_mode') | int == 1 %}
                      Anti-Feed
                    {% elif states('sensor.marstek_1_user_work_mode') | int == 2 %}
                      Trade
                    {% else %}
                      Manual
                    {% endif %}
                target:
                  entity_id: input_select.marstek_1_user_work_mode_input_select
          - conditions:
              - condition: trigger
                id:
                  - input_select_to_sensor_marstek_1
            sequence:
              - action: modbus.write_register
                metadata: {}
                data:
                  hub: MarstekVenus1
                  address: 43000
                  slave: 1
                  value: >
                    {% if is_state('input_select.marstek_1_user_work_mode_input_select',
                    'Manual') %}
                      0
                    {% elif is_state('input_select.marstek_1_user_work_mode_input_select',
                    'Anti-Feed') %}
                      1
                    {% elif is_state('input_select.marstek_1_user_work_mode_input_select',
                    'Trade') %}
                      2
                    {% else %}
                      0
                    {% endif %}

  - id: marstek_1_sync_modbus_and_max_charge
    alias: "Marstek 1 Sync Modbus and Maximum Charge"
    description: "sync modbus sensor with maximum charge"
    mode: single
    triggers:
      - trigger: state
        entity_id:
          - sensor.marstek_1_capacity_and_power_registers
        id: max_sensor_marstek_1_to_charge_input_number
      - trigger: state
        entity_id:
          - input_number.marstek_1_set_max_charging_power
        id: charge_input_number_to_max_sensor_marstek_1
    conditions: []
    actions:
      - choose:
          - conditions:
              - condition: trigger
                id:
                  - max_sensor_marstek_1_to_charge_input_number
            sequence:
              - action: input_number.set_value
                metadata: {}
                data:
                  value: "{{ states('sensor.marstek_1_capacity_and_power_registers').split(',')[2] | int | abs }}"
                target:
                  entity_id: input_number.marstek_1_set_max_charging_power
          - conditions:
              - condition: trigger
                id:
                  - charge_input_number_to_max_sensor_marstek_1
            sequence:
              - action: modbus.write_register
                metadata: {}
                data:
                  hub: MarstekVenus1
                  slave: 1
                  address: 44002
                  value: "{{ states('input_number.marstek_1_set_max_charging_power') | int | abs }}"

  - id: marstek_1_sync_modbus_and_max_discharge
    alias: "Marstek 1 Sync Modbus and Maximum Discharge"
    description: "sync modbus sensor with maximum discharge"
    mode: single
    triggers:
      - trigger: state
        entity_id:
          - sensor.marstek_1_capacity_and_power_registers
        id: max_sensor_marstek_1_to_discharge_input_number
      - trigger: state
        entity_id:
          - input_number.marstek_1_set_max_discharging_power
        id: discharge_input_number_to_max_sensor_marstek_1
    conditions: []
    actions:
      - choose:
          - conditions:
              - condition: trigger
                id:
                  - max_sensor_marstek_1_to_discharge_input_number
            sequence:
              - action: input_number.set_value
                metadata: {}
                data:
                  value: "{{ states('sensor.marstek_1_capacity_and_power_registers').split(',')[3] | int | abs }}"
                target:
                  entity_id: input_number.marstek_1_set_max_discharging_power
          - conditions:
              - condition: trigger
                id:
                  - discharge_input_number_to_max_sensor_marstek_1
            sequence:
              - action: modbus.write_register
                metadata: {}
                data:
                  hub: MarstekVenus1
                  slave: 1
                  address: 44003
                  value: "{{ states('input_number.marstek_1_set_max_discharging_power') | int | abs }}"

  - id: marstek_1_sync_modbus_and_battery_min_soc
    alias: "Marstek 1 Sync Modbus and Min SOC"
    description: "sync modbus sensor with min SOC"
    mode: single
    triggers:
      - trigger: state
        entity_id:
          - sensor.marstek_1_capacity_and_power_registers
        id: min_soc_sensor_marstek_1_to_min_soc_input_number
      - trigger: state
        entity_id:
          - input_number.marstek_1_set_battery_min_soc
        id: min_soc_input_number_to_min_soc_sensor_marstek_1
    conditions: []
    actions:
      - choose:
          - conditions:
              - condition: trigger
                id:
                  - min_soc_sensor_marstek_1_to_min_soc_input_number
            sequence:
              - action: input_number.set_value
                metadata: {}
                data:
                  value: "{{ (( states('sensor.marstek_1_capacity_and_power_registers').split(',')[1] | float / 10 ) - 1 ) | round(1) }}"
                target:
                  entity_id: input_number.marstek_1_set_battery_min_soc
          - conditions:
              - condition: trigger
                id:
                  - min_soc_input_number_to_min_soc_sensor_marstek_1
            sequence:
              - action: modbus.write_register
                metadata: {}
                data:
                  hub: MarstekVenus1
                  slave: 1
                  address: 44001
                  value: "{{ ((( states('input_number.marstek_1_set_battery_min_soc') | int + 1 ) | float ) * 10 ) | int | abs }}"

  - id: marstek_1_sync_modbus_and_battery_max_soc
    alias: "Marstek 1 Sync Modbus and Max SOC"
    description: "sync modbus sensor with min SOC"
    mode: single
    triggers:
      - trigger: state
        entity_id:
          - sensor.marstek_1_capacity_and_power_registers
        id: max_soc_sensor_marstek_1_to_max_soc_input_number
      - trigger: state
        entity_id:
          - input_number.marstek_1_set_battery_max_soc
        id: max_soc_input_number_to_max_soc_sensor_marstek_1
    conditions: []
    actions:
      - choose:
          - conditions:
              - condition: trigger
                id:
                  - max_soc_sensor_marstek_1_to_max_soc_input_number
            sequence:
              - action: input_number.set_value
                metadata: {}
                data:
                  value: "{{ (( states('sensor.marstek_1_capacity_and_power_registers').split(',')[0] | float / 10 ) ) | round(1) }}"
                target:
                  entity_id: input_number.marstek_1_set_battery_max_soc
          - conditions:
              - condition: trigger
                id:
                  - max_soc_input_number_to_max_soc_sensor_marstek_1
            sequence:
              - action: modbus.write_register
                metadata: {}
                data:
                  hub: MarstekVenus1
                  slave: 1
                  address: 44000
                  value: "{{ ((( states('input_number.marstek_1_set_battery_max_soc') | int ) | float ) * 10 ) | int | abs }}"

# ----------------
# TEMPLATE SENSORS
# ----------------
template:
  - sensor:
      - name: "Marstek 1 Charging in W"
        unique_id: marstek_1_charging_in_w
        unit_of_measurement: W
        device_class: power
        state_class: measurement
        state: >
          {% if states('sensor.marstek_1_ac_power') | float(default=0) < 0 %}
            {{ states('sensor.marstek_1_ac_power') | float(default=0) * -1 }}
          {% else %}
            0
          {% endif %}

      - name: "Marstek 1 Discharging in W"
        unique_id: marstek_1_discharging_in_w
        unit_of_measurement: W
        device_class: power
        state_class: measurement
        state: >
          {% if states('sensor.marstek_1_ac_power') | float(default=0) > 0 %}
            {{ states('sensor.marstek_1_ac_power') | float(default=0) }}
          {% else %}
            0
          {% endif %}

      - name: "Marstek 1 Force Charge/Discharge Mode Status"
        unique_id: marstek_1_force_charge_discharge_mode_status
        state: >
          {% set mode = states('sensor.marstek_1_force_charge_discharge_mode') | int %}
          {% if mode == 0 %}
            Stop
          {% elif mode == 1 %}
            Charge
          {% elif mode == 2 %}
            Discharge
          {% else %}
            Unknown
          {% endif %}

      - name: "Marstek 1 RS485 Control Mode Status"
        unique_id: marstek_1_rs485_control_mode_status
        state: >
          {% set mode = states('sensor.marstek_1_rs485_control_mode') | int %}
          {% if mode == 21930 %}
            Enabled
          {% elif mode == 21947 %}
            Disabled
          {% else %}
            Unknown
          {% endif %}

      - name: "Marstek 1 State"
        unique_id: marstek_1_state
        state: >
          {% set mapping = {
            0:'Sleep',
            1:'Standby',
            2:'Charge',
            3:'Discharge',
            4:'Backup/Fault',
            5:'Idle',
            6:'AC bypass' } %}
          {{ mapping[states('sensor.marstek_1_inverter_state') | int] }}

      - name: "Marstek 1 Operational mode"
        unique_id: marstek_1_operational mode
        state: >
          {% set mapping = {
            0:'Manual',
            1:'Anti-Feed',
            2:'Trade' } %}
          {{ mapping[states('sensor.marstek_1_user_work_mode') | int] }}

      # marstek_1_alarm_state
      # reg 0 bit 0 PLL Abnormal Restart
      # reg 0 bit 1 Overtemperature Limit
      # reg 0 bit 2 Low Temperature Limit
      # reg 0 bit 3 Fan Abnormal Warning
      # reg 0 bit 4 Low Battery SOC Warning
      # reg 0 bit 5 Output Overcurrent Warning
      # reg 0 bit 6 Abnormal Line Sequence Detection
      - name: "Marstek 1 Alarm PLL Abnormal Restart"
        unique_id: marstek_1_alarm_PLL_abnormal_restart
        state: >
          {% if has_value('sensor.marstek_1_alarm_state') %}
          {% set values= states('sensor.marstek_1_alarm_state') %}
          {% set code= values.split(',')[0] %}
          {% set mask= 0x01 %}
          {{ code | int | bitwise_and(mask) }}
          {% else %}
          0
          {% endif %}

      - name: "Marstek 1 Alarm Overtemperature Limit"
        unique_id: marstek_1_alarm_overtemperature_limit
        state: >
          {% if has_value('sensor.marstek_1_alarm_state') %}
          {% set values= states('sensor.marstek_1_alarm_state') %}
          {% set code= values.split(',')[0] %}
          {% set mask= 0x02 %}
          {{ code | int | bitwise_and(mask) }}
          {% else %}
          0
          {% endif %}

      - name: "Marstek 1 Alarm Low Temperature Limit"
        unique_id: marstek_1_alarm_low_temperature_limit
        state: >
          {% if has_value('sensor.marstek_1_alarm_state') %}
          {% set values= states('sensor.marstek_1_alarm_state') %}
          {% set code= values.split(',')[0] %}
          {% set mask= 0x48 %}
          {{ code | int | bitwise_and(mask) }}
          {% else %}
          0
          {% endif %}

      - name: "Marstek 1 Alarm Fan Abnormal Warning"
        unique_id: marstek_1_alarm_fan_abnormal_warning
        state: >
          {% if has_value('sensor.marstek_1_alarm_state') %}
          {% set values= states('sensor.marstek_1_alarm_state') %}
          {% set code= values.split(',')[0] %}
          {% set mask= 0x08 %}
          {{ code | int | bitwise_and(mask) }}
          {% else %}
          0
          {% endif %}

      - name: "Marstek 1 Alarm Low Battery SOC Warning"
        unique_id: marstek_1_alarm_low_battery_SOC_warning
        state: >
          {% if has_value('sensor.marstek_1_alarm_state') %}
          {% set values= states('sensor.marstek_1_alarm_state') %}
          {% set code= values.split(',')[0] %}
          {% set mask= 0x10 %}
          {{ code | int | bitwise_and(mask) }}
          {% else %}
          0
          {% endif %}

      - name: "Marstek 1 Alarm Output Overcurrent Warning"
        unique_id: marstek_1_alarm_output_overcurrent_warning
        state: >
          {% if has_value('sensor.marstek_1_alarm_state') %}
          {% set values= states('sensor.marstek_1_alarm_state') %}
          {% set code= values.split(',')[0] %}
          {% set mask= 0x20 %}
          {{ code | int | bitwise_and(mask) }}
          {% else %}
          0
          {% endif %}

      - name: "Marstek 1 Alarm Abnormal Line Sequence Detection"
        unique_id: marstek_1_alarm_abnormal_line_sequence_detection
        state: >
          {% if has_value('sensor.marstek_1_alarm_state') %}
          {% set values= states('sensor.marstek_1_alarm_state') %}
          {% set code= values.split(',')[0] %}
          {% set mask= 0x40 %}
          {{ code | int | bitwise_and(mask) }}
          {% else %}
          0
          {% endif %}

      # marstek_1_alarm_state
      # reg 1 bit 0 WIFI Abnormal
      # reg 1 bit 1 Blutooth Abnormal
      # reg 1 bit 2 Network Abnormal
      # reg 1 bit 3 CT Connection Abnormal
      - name: "Marstek 1 Alarm WIFI abnormal"
        unique_id: marstek_1_alarm_wifi_abnormal
        state: >
          {% if has_value('sensor.marstek_1_alarm_state') %}
          {% set values= states('sensor.marstek_1_alarm_state') %}
          {% set code= values.split(',')[1] %}
          {% set mask= 0x01 %}
          {{ code | int | bitwise_and(mask) }}
          {% else %}
          0
          {% endif %}

      - name: "Marstek 1 Alarm Blutooth abnormal"
        unique_id: marstek_1_alarm_blutooth_abnormal
        state: >
          {% if has_value('sensor.marstek_1_alarm_state') %}
          {% set values= states('sensor.marstek_1_alarm_state') %}
          {% set code= values.split(',')[1] %}
          {% set mask= 0x02 %}
          {{ code | int | bitwise_and(mask) }}
          {% else %}
          0
          {% endif %}

      - name: "Marstek 1 Alarm Network abnormal"
        unique_id: marstek_1_alarm_network_abnormal
        state: >
          {% if has_value('sensor.marstek_1_alarm_state') %}
          {% set values= states('sensor.marstek_1_alarm_state') %}
          {% set code= values.split(',')[1] %}
          {% set mask= 0x48 %}
          {{ code | int | bitwise_and(mask) }}
          {% else %}
          0
          {% endif %}

      - name: "Marstek 1 Alarm CT connection abnormal"
        unique_id: marstek_1_alarm_ct_connection_abnormal
        state: >
          {% if has_value('sensor.marstek_1_alarm_state') %}
          {% set values= states('sensor.marstek_1_alarm_state') %}
          {% set code= values.split(',')[1] %}
          {% set mask= 0x08 %}
          {{ code | int | bitwise_and(mask) }}
          {% else %}
          0
          {% endif %}

      - name: "Marstek 1 Battery maximum SOC (Charge)"
        unique_id: marstek_1_battery_maximum_soc
        unit_of_measurement: "%"
        state: >
          {% set sens= states('sensor.marstek_1_capacity_and_power_registers').split(',')[0] | float(default=0)  %}
          {{ (sens / 10) | round(1) }}

      - name: "Marstek 1 Battery minimum SOC (Discharge)"
        unique_id: marstek_1_battery_minimum_soc
        unit_of_measurement: "%"
        state: >
          {% set sens= states('sensor.marstek_1_capacity_and_power_registers').split(',')[1] | float(default=0) %}
          {{ ((sens / 10) -1) | round(1) }}

      - name: "Marstek 1 Maximum Charge Power"
        unique_id: marstek_1_max_charge_power
        unit_of_measurement: W
        device_class: power
        state_class: measurement
        state: >
          {{ states('sensor.marstek_1_capacity_and_power_registers').split(',')[2] | int(1) }}

      - name: "Marstek 1 Maximum Discharge Power"
        unique_id: marstek_1_max_discharge_power
        unit_of_measurement: W
        device_class: power
        state_class: measurement
        state: >
          {{ states('sensor.marstek_1_capacity_and_power_registers').split(',')[3] | int(1) }}

      - name: "Marstek 1 Battery Cell Voltage Delta"
        unique_id: marstek_1_battery_cell_voltage_delta
        unit_of_measurement: "mV"
        device_class: voltage
        state_class: measurement
        state: >
          {% set sens1= states('sensor.marstek_1_battery_maximum_cell_voltage') | float(default=0) * 1000 %}
          {% set sens2= states('sensor.marstek_1_battery_minimum_cell_voltage') | float(default=0) * 1000 %}
          {{ (sens1 - sens2) | round(0) }}

      # Calculation does not add up as it should, Tweakers is not correct on this.
      # Fixed it, now use sensors from Modbus and made it decimals 2
      - name: "Marstek 1 Efficiency Percentage"
        unique_id: marstek_1_efficiency_percentage
        unit_of_measurement: "%"
        state_class: measurement
        state: >
          {% set charging = states('sensor.marstek_1_total_charging_energy') | float(0) %}
          {% set discharging = states('sensor.marstek_1_total_discharging_energy') | float(0) %}
          {% if charging > 0 %}
            {{ ((discharging / charging) * 100) | float(0) | round(2) }}
          {% else %}
            0
          {% endif %}

      - name: "Marstek 1 Efficiency Percentage (monthly)"
        unique_id: marstek_1_efficiency_percentage_monthly
        unit_of_measurement: "%"
        state_class: measurement
        state: >
          {% set charging = states('sensor.marstek_1_monthly_charging_energy') | float(0) %}
          {% set discharging = states('sensor.marstek_1_monthly_discharging_energy') | float(0) %}
          {% if charging > 0 %}
            {{ ((discharging / charging) * 100) | float(0) | round(2) }}
          {% else %}
            0
          {% endif %}

      - name: "Marstek 1 Battery SOC in Wh"
        unique_id: marstek_1_battery_soc_in_Wh
        unit_of_measurement: Wh
        state_class: measurement
        device_class: energy_storage
        state: >
          {% set maxbat = 5 | float(default=0) %}
          {% set currentsoc= 11.0 | float(default=0) %}
          {% if has_value('sensor.marstek_1_battery_energy') %}
            {% set maxbat= (states("sensor.marstek_1_battery_energy") | float(default=0) * 1024) | round(0) %}
          {% endif %}
          {% if has_value('sensor.marstek_1_battery_soc') %}
            {% set currentsoc= states("sensor.marstek_1_battery_soc") | float(default=0) | round(1) %}
          {% endif %}
          {% set currentbat= (currentsoc | float(default=0) * (maxbat / 100 )) | int %}
          {{ currentbat }}

  - switch:
      - unique_id: marstek_1_rs485_control_mode_switch
        turn_on:
          - action: modbus.write_register
            data:
              hub: MarstekVenus1
              unit: 1
              address: 42000
              value: 21930
        turn_off:
          - action: modbus.write_register
            data:
              hub: MarstekVenus1
              unit: 1
              address: 42000
              value: 21947
        # default_entity_id: switch.marstek_1_rs485_control_mode_switch
        name: Marstek 1 RS485 Control Mode Switch
        state:
          "{% set mode = states('sensor.marstek_1_rs485_control_mode') | int %}
          {{ mode == 21930 }}  # True (ON) when Enabled (21930), False (OFF) otherwise"

#---------
# SWITCHES
#---------
#switch:
#  - platform: template
#    switches:
#      marstek_1_rs485_control_mode_switch:
#        friendly_name: "Marstek 1 RS485 Control Mode Switch"
#        unique_id: marstek_1_rs485_control_mode_switch
#        value_template: >
#          {% set mode = states('sensor.marstek_1_rs485_control_mode') | int %}
#          {{ mode == 21930 }}  # True (ON) when Enabled (21930), False (OFF) otherwise
#        turn_on:
#          action: modbus.write_register
#          data:
#            hub: MarstekVenus1
#            unit: 1
#            address: 42000
#            value: 21930 # Write 0x55AA to enable RS485 control mode
#        turn_off:
#          action: modbus.write_register
#          data:
#            hub: MarstekVenus1
#            unit: 1
#            address: 42000
#            value: 21947 # Write 0x55BB to disable RS485 control mode

# -------
# SENSORS
# -------
sensor:
  - platform: integration
    name: Marstek 1 Discharging in kWh
    unique_id: marstek_1_discharging_in_kwh
    source: sensor.marstek_1_discharging_in_w
    round: 2
    unit_prefix: k
    unit_time: h
    method: left
  - platform: integration
    name: Marstek 1 Charging in kWh
    unique_id: marstek_1_charging_in_kwh
    source: sensor.marstek_1_charging_in_w
    round: 2
    unit_prefix: k
    unit_time: h
    method: left

# --------------
# UTILITY METERS
# --------------
utility_meter:
  daily_discharge_1:
    name: Marstek 1 Daily Discharging in kWh
    unique_id: marstek_1_daily_discharging_in_kwh
    source: sensor.marstek_1_discharging_in_kwh
    cycle: daily

  daily_charge_1:
    name: Marstek 1 Daily Charging in kWh
    unique_id: marstek_1_daily_charging_in_kwh
    source: sensor.marstek_1_charging_in_kwh
    cycle: daily
# EOF 2444
